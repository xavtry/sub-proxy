import { createTab, switchTab, getActiveTabId, closeTab, restoreTabs, getAllTabs } from './tabManager.js';
import { loadSearch } from './searchHandler.js';
import { bindUIEvents, showHomeScreen, hideHomeScreen, updateTabBar } from './ui.js';
import { log, logError, logInfo } from './logger.js';
import { saveSession, loadSession } from './session.js';
import { applySettings, getSettings } from './settingsPanel.js';
import { showErrorOverlay, hideErrorOverlay } from './errorOverlay.js';

let initialized = false;

function initApp() {
  if (initialized) return;
  initialized = true;

  logInfo('Initializing SUB Recoded V2...');

  bindUIEvents({
    onNewTab: handleNewTab,
    onSearch: handleSearch,
    onCloseTab: handleCloseTab,
    onSwitchTab: handleSwitchTab,
    onSettingsChange: handleSettingsChange
  });

  const savedTabs = loadSession();
  if (savedTabs && savedTabs.length > 0) {
    restoreTabs(savedTabs);
    switchTab(savedTabs[0].id);
    hideHomeScreen();
  } else {
    handleNewTab();
    showHomeScreen();
  }

  logInfo('App initialized.');
}

function handleNewTab() {
  try {
    const tabId = createTab();
    switchTab(tabId);
    showHomeScreen();
    updateTabBar();
    log(`New tab created: ${tabId}`);
  } catch (err) {
    logError('Failed to create new tab');
    showErrorOverlay('Could not create a new tab.');
  }
}

function handleSearch(query) {
  try {
    const tabId = getActiveTabId();
    if (!tabId) {
      logError('No active tab for search');
      return;
    }
    if (!query || query.trim().length === 0) {
      logError('Empty search query');
      return;
    }

    hideHomeScreen();
    loadSearch(tabId, query);
    saveSession(tabId, query);
    log(`Search triggered in ${tabId}: ${query}`);
  } catch (err) {
    logError(`Search failed: ${err.message}`);
    showErrorOverlay('Search failed. Try again.');
  }
}

function handleCloseTab(tabId) {
  try {
    closeTab(tabId);
    log(`Tab closed: ${tabId}`);
    updateTabBar();

    const remainingTabs = getAllTabs();
    if (remainingTabs.length === 0) {
      handleNewTab();
    } else {
      switchTab(remainingTabs[0].id);
    }
  } catch (err) {
    logError(`Failed to close tab: ${tabId}`);
    showErrorOverlay('Could not close tab.');
  }
}

function handleSwitchTab(tabId) {
  try {
    switchTab(tabId);
    hideHomeScreen();
    log(`Switched to tab: ${tabId}`);
  } catch (err) {
    logError(`Failed to switch tab: ${tabId}`);
    showErrorOverlay('Could not switch tab.');
  }
}

function handleSettingsChange(newSettings) {
  try {
    applySettings(newSettings);
    log(`Settings updated: ${JSON.stringify(newSettings)}`);
  } catch (err) {
    logError('Failed to apply settings');
    showErrorOverlay('Settings update failed.');
  }
}

function handleGlobalErrors() {
  window.onerror = (msg, src, line, col, err) => {
    logError(`Global error: ${msg} at ${src}:${line}:${col}`);
    showErrorOverlay('An unexpected error occurred.');
  };

  window.onunhandledrejection = (event) => {
    logError(`Unhandled promise rejection: ${event.reason}`);
    showErrorOverlay('Something went wrong.');
  };
}

document.addEventListener('DOMContentLoaded', () => {
  try {
    initApp();
    handleGlobalErrors();
  } catch (err) {
    logError('App failed to initialize');
    showErrorOverlay('Initialization error.');
  }
});

